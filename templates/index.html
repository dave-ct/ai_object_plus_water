<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <!-- Ensures mobile devices scale properly -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Camera Feed</title>

    <style>
      /* Basic reset and body styling */
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: #f2f2f2;
      }
      /* Container for everything */
      .container {
        max-width: 900px; /* adjust as you like */
        margin: 0 auto;
        padding: 1em;
        background: #fff;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      h1 {
        margin-top: 0;
      }
      /* We reduce top/bottom margins on sections to keep everything closer. */
      .mode-buttons {
        margin: 0.5em 0;
      }
      /* Make the image responsive */
      .video-container img {
        max-width: 100%;  /* Scale down for smaller devices */
        height: auto;
        border: 1px solid #ccc;
      }
      hr {
        margin: 0.5em 0;
      }
      button {
        background: #007BFF;
        color: white;
        padding: 0.5em 1em;
        border: none;
        border-radius: 4px;
        margin: 0.25em;
        cursor: pointer;
        font-size: 1rem;
      }
      button:hover {
        background: #0056b3;
      }
      /* For a "stop" or danger action, you could color them differently */
      .danger {
        background: #dc3545;
      }
      /* Hidden utility class */
      .hidden {
        display: none;
      }
      /* Flexible row to hold columns side by side */
      .flex-row {
        display: flex;
        flex-wrap: wrap;  /* allows wrapping on smaller screens */
        gap: 1em;         /* spacing between columns */
        align-items: flex-start; /* align columns at the top */
        margin: 1em 0;
      }
      /* Each column in the flex row */
      .column {
        flex: 1;   /* each column can grow/shrink equally */
        min-width: 200px; /* ensures columns don't shrink too small */
      }
      /* Direction buttons: reduce spacing between them */
      .direction-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .direction-buttons-row {
        display: flex;
        justify-content: center;
        margin: 0.2em 0;  /* smaller vertical gap */
      }
      /* Additional style to reduce horizontal spacing between direction buttons */
      .direction-buttons-row button {
        margin: 0.2em;  /* smaller gap between buttons themselves */
      }
      .status-panel {
        background: #fafafa;
        border: 1px solid #ccc;
        padding: 0.5em;
      }
      .status-panel p {
        margin: 0.25em 0;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Give the heading an ID so we can update its text dynamically -->
      <h1 id="mainHeading">Live Camera Feed (Auto)</h1>

      <!-- Mode Toggle Buttons -->
      <div class="mode-buttons">
        <!-- Give these buttons IDs so we can hide/show them in JavaScript -->
        <button id="autoModeBtn" onclick="setMode('auto')">Auto Mode</button>
        <button id="manualModeBtn" onclick="setMode('manual')">Manual Mode</button>
        <button onclick="location.href='/recordings'">View Recordings</button>
        <!-- NEW BUTTON: System Info -->
        <button onclick="location.href='/system'">System Info</button>
      </div>

      <hr>

      <!-- Camera Feed -->
      <div class="video-container">
        <img src="/video_feed" alt="Camera Stream">
      </div>

      <hr>

      <!-- Water Pistol Controls + "Set Position" button in the same row -->
      <div class="flex-row">
        <div class="column" id="waterPistolControls">
          <button onclick="fetch('/water_pistol?action=start')">Start Water</button>
          <button class="danger" onclick="fetch('/water_pistol?action=stop')">Stop Water</button>
          <!-- Hidden by default if not in manual mode -->
          <button id="setPositionBtn" class="hidden" onclick="setPosition()">Set Position</button>
        </div>
      </div>

      <!-- A row with two columns: LEFT (Status Panel), RIGHT (Manual Movement) -->
      <div class="flex-row">
        <!-- Column: Status Panel -->
        <div class="column">
          <div class="status-panel" id="statusPanel">
            <p><strong>Pan Angle:</strong> <span id="panAngle">0</span></p>
            <p><strong>Tilt Angle:</strong> <span id="tiltAngle">0</span></p>
            <p><strong>Mode:</strong> <span id="modeDisplay">Auto</span></p>
            <p><strong>Water Pistol:</strong> <span id="waterPistolStatus">Stopped</span></p>
            <p><strong>Recording:</strong> <span id="recordingStatus">Not recording</span></p>
          </div>
        </div>

        <!-- Column: Manual Movement (hidden by default if not in manual mode) -->
        <div class="column hidden" id="manualControls">
          <div class="direction-buttons">
            <div class="direction-buttons-row">
              <button onclick="movePanTilt('up')">Up</button>
            </div>
            <div class="direction-buttons-row">
              <button onclick="movePanTilt('left')">Left</button>
              <button onclick="movePanTilt('right')">Right</button>
            </div>
            <div class="direction-buttons-row">
              <button onclick="movePanTilt('down')">Down</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentMode = 'auto';  // Start in AUTO by default

      function setMode(mode) {
        fetch(`/set_mode?mode=${mode}`)
          .then(response => {
            if (!response.ok) {
              alert("Error setting mode: " + response.statusText);
            } else {
              currentMode = mode;
              // Update the heading immediately
              const heading = document.getElementById('mainHeading');
              heading.textContent = mode === 'auto'
                ? "Live Camera Feed (Auto)"
                : "Live Camera Feed (Manual)";

              toggleManualControls(mode);
              toggleModeButtons(mode);
            }
          })
          .catch(err => alert("Failed to set mode: " + err));
      }

      function toggleManualControls(mode) {
        const manualDiv = document.getElementById('manualControls');
        const setPosBtn = document.getElementById('setPositionBtn');

        // Show/Hide the movement buttons + "Set Position" if in manual mode
        if (mode === 'manual') {
          manualDiv.classList.remove('hidden');
          setPosBtn.classList.remove('hidden');
        } else {
          manualDiv.classList.add('hidden');
          setPosBtn.classList.add('hidden');
        }
      }

      // Show/hide the Auto Mode and Manual Mode buttons
      function toggleModeButtons(mode) {
        const autoBtn = document.getElementById('autoModeBtn');
        const manualBtn = document.getElementById('manualModeBtn');

        if (mode === 'auto') {
          // Already in auto => hide "Auto Mode" button, show "Manual Mode"
          autoBtn.classList.add('hidden');
          manualBtn.classList.remove('hidden');
        } else {
          // In manual => hide "Manual Mode" button, show "Auto Mode"
          autoBtn.classList.remove('hidden');
          manualBtn.classList.add('hidden');
        }
      }

      function movePanTilt(direction) {
        if (currentMode !== 'manual') {
          alert("Please switch to MANUAL mode first.");
          return;
        }
        fetch(`/move?direction=${direction}`)
          .then(response => {
            if (!response.ok) {
              alert("Error moving pan/tilt: " + response.statusText);
            }
          })
          .catch(err => alert("Failed to move pan/tilt: " + err));
      }

      function setPosition() {
        if (currentMode !== 'manual') {
          alert("Please switch to MANUAL mode to set position.");
          return;
        }
        fetch('/set_home')
          .then(response => {
            if (!response.ok) {
              alert("Error setting home: " + response.statusText);
            } else {
              alert("Current position set as home.");
            }
          })
          .catch(err => alert("Failed to set position: " + err));
      }

      // ---- AUTOMATIC STATUS UPDATING ----
      function updateStatus() {
        fetch('/status')
          .then(response => response.json())
          .then(data => {
            // Update numeric angles (round or fix decimals if you like)
            document.getElementById('panAngle').innerText = data.current_pan_angle.toFixed(2);
            document.getElementById('tiltAngle').innerText = data.current_tilt_angle.toFixed(2);

            // Convert auto_mode to 'Auto' or 'Manual'
            const modeText = data.auto_mode ? 'Auto' : 'Manual';
            document.getElementById('modeDisplay').innerText = modeText;

            // Also show/hide relevant UI based on the actual mode from server
            currentMode = data.auto_mode ? 'auto' : 'manual';
            toggleManualControls(currentMode);
            toggleModeButtons(currentMode);

            // Update the heading
            const heading = document.getElementById('mainHeading');
            heading.textContent = data.auto_mode
              ? "Live Camera Feed (Auto)"
              : "Live Camera Feed (Manual)";

            // Water pistol
            document.getElementById('waterPistolStatus').innerText = data.water_pistol_active ? 'Firing' : 'Stopped';

            // Recording
            document.getElementById('recordingStatus').innerText = data.is_recording ? 'Recording' : 'Not recording';
          })
          .catch(err => console.error('Failed to fetch status:', err));
      }

      // Update the status panel immediately after page load...
      updateStatus();
      // ...and then every second
      setInterval(updateStatus, 1000);
    </script>
  </body>
</html>






